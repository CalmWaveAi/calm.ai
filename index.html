<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calm AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  margin:0;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#0f1f1c;
  color:#e9f6f3;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}
.app {
  width:90%;
  max-width:900px;
  background:rgba(255,255,255,0.08);
  border-radius:28px;
  padding:36px;
  backdrop-filter:blur(20px);
}
textarea {
  width:100%;
  height:140px;
  border-radius:22px;
  border:none;
  padding:18px;
  background:rgba(255,255,255,.15);
  color:#e9f6f3;
  resize:none;
}
button {
  margin-top:22px;
  padding:16px 36px;
  border-radius:999px;
  border:none;
  background:#6fd3c4;
  font-size:17px;
  color:#06332c;
  cursor:pointer;
}
.status {
  margin-top:16px;
  font-size:14px;
  color:#a8cfc7;
}
.orb {
  width:140px;
  height:140px;
  margin:0 auto 30px;
  border-radius:50%;
  background:radial-gradient(circle at top,#a7fff1,#4fbfb0);
  animation:drift 10s ease-in-out infinite;
  box-shadow:0 0 80px rgba(111,211,196,.6);
}
@keyframes drift {
  0%{transform:translateY(0)}
  50%{transform:translateY(-14px)}
  100%{transform:translateY(0)}
}
</style>
</head>
<body>

<div class="app">
  <div class="orb"></div>
  <h1>Relax and Let Go</h1>
  <textarea id="textInput" placeholder="Describe how you're feeling…"></textarea>
  <br>
  <button id="startBtn">Begin Calm</button>
  <div class="status" id="status"></div>
</div>

<script>
let audioCtx;
let musicGain;
let breathInterval;

/* ---------- EMOTION ---------- */
function detectEmotion(text){
  const t = text.toLowerCase();
  if(t.includes("sad") || t.includes("lonely")) return "comfort";
  if(t.includes("anxious") || t.includes("stress")) return "soothing";
  if(t.includes("sleep") || t.includes("tired")) return "sleepy";
  return "calm";
}

/* ---------- STORY ---------- */
function generateStory(emotion){
  const map = {
    comfort: [
      "Take a slow breath. You are safe. You are supported.",
      "Gentle warmth surrounds you. Nothing is required of you right now."
    ],
    soothing: [
      "Let your shoulders soften. Each breath releases tension.",
      "The world slows down. You can rest here."
    ],
    sleepy: [
      "Your body feels heavy and relaxed. Sleep comes easily.",
      "Every breath carries you deeper into rest."
    ],
    calm: [
      "Everything is quiet. Peace flows gently through you.",
      "There is nothing to fix. Simply be."
    ]
  };
  const arr = map[emotion];
  return arr[Math.floor(Math.random()*arr.length)];
}

/* ---------- START ---------- */
document.getElementById("startBtn").onclick = () => {
  if(audioCtx) audioCtx.close();
  clearInterval(breathInterval);

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  playAmbience();

  const emotion = detectEmotion(textInput.value);
  const story = generateStory(emotion);

  speakWithBreaths(story);

  status.innerText = "Relax… soft voice, breathing, and ambience playing.";
};

/* ---------- AMBIENT MUSIC ---------- */
function playAmbience(){
  musicGain = audioCtx.createGain();
  musicGain.gain.value = 0.025;
  musicGain.connect(audioCtx.destination);

  [110, 150, 190].forEach(f => {
    const osc = audioCtx.createOscillator();
    osc.type = "sine";
    osc.frequency.value = f + Math.random()*10;
    osc.connect(musicGain);
    osc.start();
  });
}

/* ---------- BREATH SOUND ---------- */
function playBreath(){
  const noise = audioCtx.createBufferSource();
  const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.8, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);

  for(let i=0;i<data.length;i++){
    data[i] = (Math.random()*2 - 1) * 0.15;
  }

  noise.buffer = buffer;

  const filter = audioCtx.createBiquadFilter();
  filter.type = "lowpass";
  filter.frequency.value = 800;

  const gain = audioCtx.createGain();
  gain.gain.setValueAtTime(0, audioCtx.currentTime);
  gain.gain.linearRampToValueAtTime(0.04, audioCtx.currentTime + 0.3);
  gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.8);

  noise.connect(filter).connect(gain).connect(audioCtx.destination);
  noise.start();
}

/* ---------- VOICE + BREATHING ---------- */
function speakWithBreaths(text){
  const utter = new SpeechSynthesisUtterance(text);

  const voices = speechSynthesis.getVoices();
  utter.voice = voices.find(v => v.lang.startsWith("en")) || voices[0];
  utter.rate = 0.7;
  utter.pitch = 0.9;
  utter.volume = 0.85;

  musicGain.gain.value = 0.012;

  utter.onend = () => {
    musicGain.gain.value = 0.025;
  };

  if(voices.length === 0){
    speechSynthesis.onvoiceschanged = () => speechSynthesis.speak(utter);
  } else {
    speechSynthesis.speak(utter);
  }

  breathInterval = setInterval(playBreath, 6000);
}
</script>
</body>
</html>
