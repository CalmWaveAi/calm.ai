<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CalmBubble AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  height: 100vh;
  background: radial-gradient(circle at top, #eaf5f3, #c9e4df);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

.container {
  width: 90%;
  max-width: 420px;
  text-align: center;
}

.bubble {
  width: 110px;
  height: 110px;
  margin: 0 auto 25px;
  background: rgba(255,255,255,0.6);
  border-radius: 50%;
  animation: breathe 6s ease-in-out infinite;
  box-shadow:
    inset -10px -10px 25px rgba(255,255,255,0.8),
    inset 10px 10px 25px rgba(180,220,215,0.5),
    0 20px 40px rgba(0,0,0,0.08);
}

@keyframes breathe {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.08, 0.95); }
  100% { transform: scale(1); }
}

textarea {
  width: 100%;
  height: 120px;
  border-radius: 28px;
  border: none;
  padding: 20px;
  font-size: 16px;
  outline: none;
  resize: none;
  box-shadow: 0 15px 30px rgba(0,0,0,0.1);
}

button {
  width: 100%;
  margin-top: 20px;
  padding: 16px;
  border-radius: 30px;
  border: none;
  font-size: 18px;
  background: #7ccfc6;
  color: #ffffff;
  cursor: pointer;
}

button:hover {
  background: #66b7af;
}

.status {
  margin-top: 15px;
  font-size: 14px;
  color: #355;
}
</style>
</head>

<body>

<div class="container">
  <div class="bubble"></div>

  <textarea id="feelings" placeholder="How are you feeling right now?"></textarea>

  <button onclick="startCalm()">Begin Calm</button>

  <div class="status" id="status"></div>
</div>

<script>
let audioCtx;
let ambientSource;
let isRunning = false;

/* ---------- START SESSION ---------- */
function startCalm() {
  if (isRunning) return;
  isRunning = true;

  const status = document.getElementById("status");
  const text = document.getElementById("feelings").value.toLowerCase();
  status.innerText = "The AI is creating a calm space for youâ€¦";

  startAmbientSound();

  const story = generateLongStory(text);
  speakSoftly(story);
}

/* ---------- SOOTHING VOICE ---------- */
function speakSoftly(text) {
  const utterance = new SpeechSynthesisUtterance(text);

  const voices = speechSynthesis.getVoices();
  const preferred = voices.find(v =>
    v.lang.startsWith("en") &&
    (v.name.toLowerCase().includes("natural") ||
     v.name.toLowerCase().includes("google") ||
     v.name.toLowerCase().includes("female"))
  );

  if (preferred) utterance.voice = preferred;

  utterance.rate = 0.65;   // slower than normal
  utterance.pitch = 0.85;  // lower, warmer
  utterance.volume = 0.6;  // voice softer than ambience

  speechSynthesis.cancel();
  speechSynthesis.speak(utterance);
}

/* ---------- BACKGROUND AMBIENCE (PRIORITY) ---------- */
function startAmbientSound() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  const bufferSize = 2 * audioCtx.sampleRate;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);

  let last = 0;
  for (let i = 0; i < bufferSize; i++) {
    const rand = Math.random() * 2 - 1;
    data[i] = (last + 0.015 * rand) / 1.015;
    last = data[i];
  }

  ambientSource = audioCtx.createBufferSource();
  ambientSource.buffer = buffer;
  ambientSource.loop = true;

  const gain = audioCtx.createGain();
  gain.gain.value = 0.12; // background is dominant

  ambientSource.connect(gain).connect(audioCtx.destination);
  ambientSource.start();
}

/* ---------- STORY GENERATION ---------- */
function generateLongStory(input) {
  let story =
    "Take a slow breath. " +
    "There is nothing you need to do right now. " +
    "Nothing you need to fix or figure out. ";

  if (input.includes("anxious") || input.includes("panic")) {
    story +=
      "Your body begins to realize that it is safe. " +
      "Each breath gently loosens the tension that has been holding on. ";
  } else if (input.includes("sad")) {
    story +=
      "A quiet warmth surrounds you, reminding you that softness still exists. ";
  } else if (input.includes("tired") || input.includes("sleep")) {
    story +=
      "Your body feels heavy in a comforting way, as if rest is finally allowed. ";
  }

  story +=
    "Imagine being somewhere peaceful. " +
    "The air is calm. The sounds around you move slowly and naturally. " +
    "Nothing rushes you. " +
    "You are exactly where you need to be. " +
    "Stay here as long as you like.";

  return story;
}

/* ---------- CLEANUP ---------- */
function stopCalm() {
  speechSynthesis.cancel();
  if (ambientSource) ambientSource.stop();
  if (audioCtx) audioCtx.close();
  isRunning = false;
}
</script>

</body>
</html>
